#!/bin/bash

HERE=`pwd`
set -exuo pipefail    # Print trace and do not keep running if something fails!


# Install dependencies
sudo apt -y install \
	curl \         # for installing latest of other things
	git \          # Emacs uses this for local history
	imagemagick \  # for lsix, catimg
	pandoc groff   # for less <something>.md


# Emacs configuration boilerplate
mkdir -p ~/.localhistory-emacs
cd ~/.localhistory-emacs && git init
mkdir -p ~/.snippets
touch ~/TIME.org

# Set up minimal ~/bin
cp -R $HERE/baseline/skel/bin ~
PATH="$HOME/bin:$PATH"

# ...and ~/$(dotfiles)
mkdir -p ~/.config
cp -R $HERE/baseline/skel/dot.config/. ~/.config
ln -s ~/.emacs.d/dot.sbt ~/.sbt
cp $HERE/baseline/skel/dot.lessfilter ~/.lessfilter

# Ammonite Scala shell
mkdir ~/.ammonite
ln -s ~/.emacs.d/predef.scala ~/.ammonite/predef.scala

# SBT and coursier
curl -L -o ~/bin/sbt https://git.io/sbt
curl -L -o ~/bin/coursier https://git.io/coursier
chmod 755 ~/bin/sbt ~/bin/coursier

# Scala/Mill
MILL_REPO=https://github.com/lihaoyi/mill
MILL_VERSION=`latest-release $MILL_REPO`
curl -L $MILL_REPO/releases/download/$MILL_VERSION/$MILL_VERSION > ~/bin/mill 
chmod +x ~/bin/mill

# Scala/Bloop
BLOOP_REPO=https://github.com/scalacenter/bloop
BLOOP_LATEST=`latest-release $BLOOP_REPO`
curl -L $BLOOP_REPO/releases/download/$BLOOP_LATEST/install.py | python


# Clojure boot/lein
curl -fsSLo ~/bin/boot https://github.com/boot-clj/boot-bin/releases/download/latest/boot.sh
chmod 755 ~/bin/boot

curl -fsSLo ~/bin/lein https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein
chmod 755 ~/bin/lein

# Note: no 'latest' link on Maven's dl page; have to upgrade this manually
cd ~/bin && curl -fsSLo maven-latest.tgz http://apache.claz.org/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz
cd ~/bin && tar -xzvf maven-latest.tgz
cd ~/bin && ln -s apache-maven* maven
cd ~/bin && cat > ~/bin/mvn <<EOF
#!/bin/bash
export MAVEN_HOME=`pwd`/maven
export M2_HOME=`pwd`/maven
`pwd`/maven/bin/mvn $@
EOF
chmod 755 ~/bin/mvn

# Ammonite Scala shell
AMMONITE_REPO=https://github.com/lihaoyi/Ammonite
AMMONITE_VER=`latest-release $MILL_REPO`
curl -L -o ~/bin/amm $AMMONITE_REPO/releases/download/$AMMONITE_VER/2.13-$AMMONITE_VER
chmod +x ~/bin/amm


# Put all the things on the path
cat >> ~/.bashrc <<EOF

export PATH="$PATH:~/bin:~/.bloop"
EOF


# Add shell completions
cat >> ~/.profile <<EOF

. $HOME/.bloop/bash/bloop
EOF


echo "See the 'baseline' folder for common apps"

